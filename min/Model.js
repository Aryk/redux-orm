"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _get=function(e,t,n){for(var r=!0;r;){var a=e,i=t,s=n;r=!1,null===a&&(a=Function.prototype);var o=Object.getOwnPropertyDescriptor(a,i);if(void 0!==o){if("value"in o)return o.value;var u=o.get;if(void 0===u)return;return u.call(s)}var l=Object.getPrototypeOf(a);if(null===l)return;e=l,t=i,n=s,r=!0,o=l=void 0}},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_lodashObjectForOwn=require("lodash/object/forOwn"),_lodashObjectForOwn2=_interopRequireDefault(_lodashObjectForOwn),_fields=require("./fields"),_Session=require("./Session"),_Session2=_interopRequireDefault(_Session),_Meta=require("./Meta"),_Meta2=_interopRequireDefault(_Meta),_QuerySet=require("./QuerySet"),_QuerySet2=_interopRequireDefault(_QuerySet),_constants=require("./constants"),_utils=require("./utils"),Model=function(){function e(t){_classCallCheck(this,e),this._initFields(t)}return _createClass(e,[{key:"_initFields",value:function(e){var t=this,n=this.getClass();this._fieldNames=[],this._fields=e;var r=n.idAttribute;(0,_lodashObjectForOwn2["default"])(e,function(e,a){t._fields[a]=e,t._fieldNames.push(a),n.definedProperties[a]||Object.defineProperty(t,a,{get:function(){return e},set:function(e){var i;n.addMutation({type:_constants.UPDATE,payload:(i={},_defineProperty(i,r,t.getId()),_defineProperty(i,a,e),i)})}})})}},{key:"getClass",value:function(){return this.constructor}},{key:"getId",value:function(){return this._fields[this.getClass().idAttribute]}},{key:"toString",value:function(){var e=this,t=this.getClass().getName(),n=this._fieldNames.map(function(t){var n=e._fields[t];return t+": "+n}).join(", ");return t+": {"+n+"}"}},{key:"equals",value:function(e){return this.getClass()===e.getClass()&&this.getId()===e.getId()}},{key:"toPlain",value:function(){var e=this,t={};return this._fieldNames.forEach(function(n){t[n]=e._fields[n]}),t}},{key:"set",value:function(e,t){this.update(_defineProperty({},e,t))}},{key:"update",value:function(e){this.getClass().addMutation({type:_constants.UPDATE,payload:{idArr:[this.getId()],updater:e}})}},{key:"delete",value:function(){this.getClass().addMutation({type:_constants.DELETE,payload:[this.getId()]})}}],[{key:"toString",value:function(){return"ModelClass: "+this.getName()}},{key:"getThroughModelClass",value:function(){return e}},{key:"getManyToManyModels",value:function(){var e=this,t=this.fields,n=this.getName(),r=[];return(0,_lodashObjectForOwn2["default"])(t,function(t,a){if(t instanceof _fields.ManyToMany){var i,s=void 0;s="this"===t.toModelName?n:t.toModelName;var o=(0,_utils.m2mFromFieldName)(n),u=(0,_utils.m2mToFieldName)(s),l=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),t}(e.getThroughModelClass());l.meta={name:(0,_utils.m2mName)(n,a)},l.fields=(i={},_defineProperty(i,o,new _fields.ForeignKey(n)),_defineProperty(i,u,new _fields.ForeignKey(s)),i),r.push(l)}}),r}},{key:"meta",value:function(){throw new Error('You must declare a static "meta" function in your Model class.')}},{key:"getMeta",value:function(){if("function"==typeof this.meta)return this.meta();if("undefined"==typeof this.meta)throw new Error("You must declare either a 'meta' class method or\n                            a 'meta' class variable in your Model Class");return this.meta}},{key:"getMetaClass",value:function(){return _Meta2["default"]}},{key:"getMetaInstance",value:function(){if(!this._meta){var e=this.getMetaClass();this._meta=new e(this.getMeta())}return this._meta}},{key:"getNextState",value:function(){if("undefined"==typeof this.state)return this.getDefaultState();var e=this.getMetaInstance(),t=this.session.getMutationsFor(this);return t.reduce(function(t,n){switch(n.type){case _constants.CREATE:return e.insert(t,n.payload);case _constants.UPDATE:return e.update(t,n.payload.idArr,n.payload.updater);case _constants.DELETE:return e["delete"](t,n.payload);default:return t}},this.state)}},{key:"reducer",value:function(e,t,n,r){return n.getNextState()}},{key:"callUserReducer",value:function(){return this.reducer(this.state,this.session.action,this,this.session)}},{key:"getDefaultState",value:function(){return this.getMetaInstance().getDefaultState()}},{key:"getName",value:function(){return this.getMetaInstance().name}},{key:"accessId",value:function(e){return this.getMetaInstance().accessId(this.state,e)}},{key:"accessIds",value:function(){return this.getMetaInstance().accessIdList(this.state)}},{key:"accessList",value:function(){return this.getMetaInstance().accessList(this.state)}},{key:"iterator",value:function(){return this.getMetaInstance().iterator(this.state)}},{key:"connect",value:function(e){if(!e instanceof _Session2["default"])throw Error("A model can only connect to a Session instance.");this._session=e}},{key:"addMutation",value:function(e){e.meta={name:this.getName()},this.session.addMutation(e)}},{key:"nextId",value:function(){var e=this.accessIds();return 0===e.length?0:Math.max.apply(Math,_toConsumableArray(e))+1}},{key:"getQuerySet",value:function(){return this.getQuerySetFromIds(this.accessIds())}},{key:"getQuerySetFromIds",value:function(e){var t=this.querySetClass;return new t(this,e)}},{key:"invalidateCaches",value:function(){this._cachedQuerySet=void 0,this._meta=void 0,this._setupDone=void 0}},{key:"all",value:function(){return this.getQuerySet()}},{key:"create",value:function(e){var t=this.idAttribute;e.hasOwnProperty(t)||(e[t]=this.nextId()),this.addMutation({type:_constants.CREATE,payload:e});var n=this;return new n(e)}},{key:"withId",value:function(e){var t=this;return new t(this.accessId(e))}},{key:"get",value:function(e){if(!this.accessIds().length)throw new Error("No entities found for model "+this.getName());var t=this;if(e.hasOwnProperty(this.idAttribute)){var n=this.accessId(e[this.idAttribute]);if("undefined"!=typeof n)return new t(n);throw new Error("Model instance not found when calling get method")}for(var r=this.iterator(),a=!1;!a;){var i=r.next();if((0,_utils.match)(e,i.value))return new t(i.value);a=i.done}throw new Error("Model instance not found when calling get method")}},{key:"setOrder",value:function(e){this.addMutation({type:_constants.ORDER,payload:e})}},{key:"state",get:function(){return this.session.getState(this.getName())}},{key:"idAttribute",get:function(){return this.getMetaInstance().idAttribute}},{key:"session",get:function(){return this._session}},{key:"query",get:function(){return this._cachedQuerySet||(this._cachedQuerySet=this.getQuerySet()),this._cachedQuerySet}}]),e}();Model.fields={},Model.definedProperties={},Model.querySetClass=_QuerySet2["default"],exports["default"]=Model,module.exports=exports["default"];